#include "mbed.h"
#include "PQ_ES920.h"

Serial pc(USBTX, USBRX, 115200);
Serial es_serial(PA_9, PA_10, 115200);

ES920 es(es_serial);

char command[1];
char* phase_names[] =  {"SAFETY", "READY", "FLIGHT", "SEP1", "SEP2", "EMERGENCY", "RECOVERY"};

void downlink_handler(char* data);

int main()
{
    pc.printf("IZU2022 GROUND STATION!!!\r\n");
    es.attach(downlink_handler);
    while(1) {
        if(pc.readable()) {
            command[0] = pc.getc() + 0x80;  //pc.getc(char)
            es.send(command, 1);    //NAME.send(char *data, int size)
            pc.printf("send:%02x\r\n", command[0]);    //0を左に2つ付加。%xは整数を16進数として入力。
        }
    }
}

void downlink_handler(char *data)
{  
    int mission_time = ((data[0]) | (data[1]<<8) | (data[2]<<16) | (data[3]<<24));
    int flight_time = ((data[4]) | (data[5]<<8) | (data[6]<<16) | (data[7]<<24));
    
    char phase = data[8];
    
    char apogee     = data[9] >> 7 & 1;
    char landed     = data[9] >> 6 & 1;
    char flight_pin = data[9] >> 5 & 1;
    char relay      = data[9] >> 4 & 1;
    char sep1       = data[9] >> 3 & 1;
    char sep2       = data[9] >> 2 & 1;
    char SEP2_NG    = data[9] >> 1 & 1;
    
    char f_sd       = data[10] >> 7 & 1;
    char f_gps      = data[10] >> 6 & 1;
    char f_ina_in   = data[10] >> 5 & 1;
    char f_ina_ex   = data[10] >> 4 & 1;
    char f_mpu      = data[10] >> 3 & 1;
    char f_adxl     = data[10] >> 2 & 1;
    char f_lps      = data[10] >> 1 & 1;
    
    int lat_int =  ((data[11]) | (data[12]<<8) | (data[13]<<16) | (data[14]<<24));
    int lon_int = ((data[15]) | (data[16]<<8) | (data[17]<<16) | (data[18]<<24));
    int alt_int = ((data[19]) | (data[20]<<8) | (data[21]<<16) | (data[22]<<24)); 
    
    int voltage_in = ((data[23]) | (data[24]<<8) | (data[25]<<16) | (data[26]<<24));
    int current_in = ((data[27]) | (data[28]<<8) | (data[29]<<16) | (data[30]<<24));
    int voltage_ex = ((data[31]) | (data[32]<<8) | (data[33]<<16) | (data[34]<<24));
    int current_ex = ((data[35]) | (data[36]<<8) | (data[37]<<16) | (data[38]<<24));
    int press_LPF = ((data[39]) | (data[40]<<8) | (data[41]<<16) | (data[42]<<24));    

    pc.printf("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■\r\n");
    pc.printf("\t\t\tPLANET-Q GROUND STATION\r\n");
    pc.printf("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■\r\n");
    pc.printf("■ 0:READY  -> SAFETY\t\t5:SEP2_NG\r\n");
    pc.printf("■ 1:SAFETY -> READY\t\t6:BUZZER\r\n");
    pc.printf("■ 2:READY  -> FLIGHT\t\tDEL:System reset\r\n");
    pc.printf("■ 3:FLIGHT -> SEP1\r\n");
    pc.printf("■ 4:EMERGENCY\r\n");
    pc.printf("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■\r\n");
    pc.printf(" MISSION TIME: %d[s]\tFLIGHT TIME: %d[s]\r\n",mission_time, flight_time);
    pc.printf("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■\r\n");
    pc.printf(" PHASE:\t%s\r\n", phase_names[phase]);
    pc.printf("\r\n");
    pc.printf(" F_Pin  SEP1  SEP2  APOGEE  RELAY  LANDED  SEP2_NG\r\n");
    pc.printf(" %d      %d     %d     %d       %d      %d       %d\r\n", flight_pin, sep1, sep2, apogee, relay, landed, SEP2_NG);
    pc.printf(" SD  GPS  INA_IN  INA_EX  LPS  MPU   ADXL\r\n");
    pc.printf(" %d   %d    %d       %d       %d    %d   %d\r\n", f_sd, f_gps, f_ina_in, f_ina_ex, f_lps, f_mpu, f_adxl);
    pc.printf("\r\n");
    pc.printf(" Lat:\t%d\r\n", lat_int);
    pc.printf(" Lon:\t%d\r\n", lon_int);
    pc.printf(" Alt:\t%d[m]\r\n", alt_int);
    pc.printf(" IN: %d[V]\t%d[mA]\r\n", (voltage_in / 1000), current_in);
    pc.printf(" EX: %d[V]\t%d[mA]\r\n", (voltage_ex / 1000), current_ex);
    pc.printf(" PRESS_LPF: %d [hPa]\r\n", press_LPF);
    pc.printf("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■\r\n");
}